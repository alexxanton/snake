#include "../snake.h"

void draw_snake(t_tail *tail, char c)
{
	//clear();
	mvaddch(tail->y, tail->x + (tail->x - 1), c);
	mvaddch(1, 1, ' ');
	//refresh();
}

int update_snake(t_tail *tail, int hdir, int vdir, int apple_x, int apple_y)
{
	t_tail *next;
	bool apple_eaten = false;

	while (tail)
	{
		if (tail->next)
		{
			next = tail->next;
			tail->x = next->x;
			tail->y = next->y;
			//if (tail->x == apple_x && tail->y == apple_y)
			//	mvaddch(20, 20, 'i');
			tail = next;
		}
		else
		{
			tail->x += hdir;
			tail->y += vdir;
			if (tail->x == apple_x && tail->y == apple_y)
				apple_eaten = true;
			mvaddch(20, 30, tail->x + (tail->x < 10 ? 48 : 55));
			mvaddch(20, 40, tail->y + (tail->y < 10 ? 48 : 55));
			tail = tail->next;
		}
			draw_snake(tail, 'o');
	}
	return (apple_eaten);
}

void clear_screen(int x, int y)
{
	for (int i = 0; i < y; i++)
	{
		for (int j = 0; j < x; j++)
			mvaddch(i, j, ' ');
	}
}

void start_game()
{
	bool loop = true;
	int key, hdir = 1, vdir = 0;
	int x, y, newx, newy;
	int apple_x = 15, apple_y = 15;

	t_tail *tail = tailnew(5, 5);
	getmaxyx(stdscr, y, x);

	while (loop)
	{
		getmaxyx(stdscr, newy, newx);
		if (newx != x || newy != y)
			getmaxyx(stdscr, y, x);
		clear_screen(x, y);
		mvaddch(apple_y, apple_x + apple_x - 1, '.');
		if (update_snake(tail, hdir, vdir, apple_x, apple_y))
			tailadd_front(&tail, tailnew(0, 0));
		refresh();
		halfdelay(5);
		key = getch();
		switch (key)
		{
			case KEY_UP:	vdir = -1;	hdir = 0;	break;
			case KEY_DOWN:	vdir =	1;	hdir = 0;	break;
			case KEY_LEFT:	hdir = -1;	vdir = 0;	break;
			case KEY_RIGHT:	hdir =	1;	vdir = 0;	break;
			case 'q':		loop =	false;			break;
			default:								break;
		}
	}
}
